---
title: 用于能源需求预测的 Cortana Intelligence 解决方案模板演练手册
description: 包含 Microsoft Cortana Intelligence 的解决方案模板，可帮助预测能源公共事业公司的需求。
services: machine-learning
author: ilanr9
manager: cgronlun
ms.service: machine-learning
ms.subservice: team-data-science-process
ms.workload: data-services
ms.topic: conceptual
ms.date: 01/24/2016
ms.author: garye
ms.openlocfilehash: 195776cda0005b3a79aa82220660fcc328f6ee98
ms.sourcegitcommit: c61c98a7a79d7bb9d301c654d0f01ac6f9bb9ce5
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/27/2018
ms.locfileid: "52426248"
---
# <a name="cortana-intelligence-solution-template-playbook-for-demand-forecasting-of-energy"></a>用于能源需求预测的 Cortana Intelligence 解决方案模板演练手册
## <a name="executive-summary"></a>执行摘要
过去几年来，物联网 (IoT)、替代能源和大数据已共同在公共事业和能源领域中创造庞大的商机。 在此同时，公共事业和整个能源工业看到用电量已失控，消费者急需更有效地控制能源用量。 因此，公共事业和智能电网公司本身极需改革与创新。 此外，许多电力和公共电网已经过时，维护和管理所费不赀。 去年，本团队在能源领域中从事许多研究。 在这些研究中，我们经常发现公共事业或 ISV（独立软件供应商）一直在发现如何预测将来的能源需求。 这些预测在其当前和将来的事业中扮演着重要角色，已成为不同用例的基础。 其中包括短期与长期的电力负载预测、事务、负载均衡、电网优化等。为了生成准确且可靠的预测，大数据和高级分析 (AA) 方法是关键因素，例如机器学习 (ML)。  

在本演练手册中，我们结合业务和分析指导，以成功开发及部署能源需求预测解决方案。 这些建议的指导可帮助公共事业、数据科研家和数据工程师创建全面运行、以基于云的需求预测解决方案。 对于刚踏入大数据和高级分析领域的公司，这种解决方案就是长期智能电源策略的菩提种子。

> [!TIP]
> 若要下载此模板的架构概述图表，请参阅[能源需求预测的 Cortana Intelligence 解决方案模板体系结构](cortana-analytics-architecture-demand-forecasting-energy.md)。  
> 
> 

## <a name="overview"></a>概述
本文介绍使用 Cortana Intelligence（尤其是 Azure 机器学习 (AML)）来实现与部署能源预测解决方案的业务、数据和技术层面。 文档包括三个主要部分 ：  

1. 了解业务  
2. 了解数据  
3. 技术实现

**了解业务**部分概述在进行投资决策之前需要了解及考虑的业务层面。 其中说明如何评估眼前的业务问题，确保预测分析和机器学习确实有效且可行。 本文档进一步说明机器学习的基本概念及如何用于解决能源预测问题。 其中概述使用方案的先决条件和检定准则。 另外还提供一些示例用例和业务方案。

数据是任何机器学习解决方案的主要成分。 本文档的**了解数据**部分介绍一些重要的数据层面。 其中概述能源预测所需的数据种类、数据质量要求，以及通常存在的数据源。 此外，说明如何使用原始数据，准备好实际主导建模部分的数据特征。

本文档的第三个部分介绍解决方案的**技术实现**层面。 特征工程设计和建模是数据科研过程的核心，因此更详细介绍。 其中介绍 Web 服务的概念，在预测分析解决方案的云部署方面，这些是很重要的机制。 另外还概述了端到端操作解决方案的典型体系结构。

此外，本文档包含参考材料，帮助进一步了解该领域和技术。

请务必注意，本文档未介绍深奥的数据科研过程，及其数学和技术层面。 可以在 [Azure ML 文档](https://azure.microsoft.com/services/machine-learning/)和[博客](https://blogs.microsoft.com/blog/tag/azure-machine-learning/)中找到这些详细信息。

### <a name="target-audience"></a>目标读者
本文档面向商务和技术人员，帮助他们认识和了解机器学习解决方案，及其在能源预测领域中的具体利用情况。

本文档还可帮助数据科研人员详细了解主导能源预测解决方案部署的高级过程。 就这方面而言，本文档也能为阅读更详细和高级的数据打下扎实的基础和起点。

### <a name="industry-trends"></a>行业趋势
过去几年来，IoT、替代能源和大数据已共同在公共事业和能源领域中创造庞大的商机。 在此同时，公共事业和整个能源工业看到用电量已失控，消费者急需更有效地控制能源用量。

许多公共事业和智能能源公司都在研发[智能电网](https://en.wikipedia.org/wiki/Smart_grid)，使用电网所生成的数据来部署使用一些方案。 许多用例脱离不了发电的固有特征：无法累积也无法贮藏。 因此，生产出来就必须用掉，别无选择。 公共事业想要变得更有效率必须预测的用电量，原因很简单，因为这样才能更好地**均衡供需**，避免浪费能源、**减少温室气体排放**及控制成本。

提到成本时，还有另一个重点，就是价格。 公共事业之间电力事务的新业务导致更需要**预测将来的电力需求和价格**。 这有助于公司确定它们的产量。

提到“智能”一词时，实际是指可学习并进行预测的电网。 它可以预测季节性的用电量变化，以及**预知暂时性过载情况并自动调整**。 通过从远程调节用电量（借助这些智能电表），就可以处理地区性过载情况。 **电网先预测再行动**，随着时间而变得越来越聪明。

本文档的余下部分着重于一系列特定的用例，介绍预测将来、短期和长期的能源需求。 多个月来我们一直努力于这些领域，已获得一些知识和技能，能够产生工业级的成果。 不久的将来，本文档还会介绍其他用例。

## <a name="business-understanding"></a>了解业务
### <a name="business-goals"></a>业务目标
**能源演示**目标在于演示可在极短时间内部署的一般预测分析和机器学习解决方案。 具体而言，我们目前的焦点是推动能源需求预测解决方案，以快速实现并利用其商业价值。 本演练手册中的信息可帮助客户实现以下目标：

* 加速机器学习解决方案的价值实现
* 能够根据其业务需求，将试验性用例扩展到其他用例或更广的范围
* 快速获得 Cortana Intelligence Suite 产品知识

本演练手册谨记这些目标，希望提供业务和技术知识来帮助实现这些目标。

### <a name="power-load-and-demand-forecasting"></a>电力负载和需求预测
在能源行业内，需求预测在许多方面可帮助解决紧急的业务问题。 事实上，需求预测可视为行业中许多核心用例的基础。 一般而言，我们考虑两种能源需求预测：短期和长期。 各有不同的用途并采用不同的方法。 两者的主要差异在于预测范围，也就是可预测的将来时间范围。

#### <a name="short-term-load-forecasting"></a>短期负载预测
在能源需求方面，短期负载预测 (STLF) 定义为对电网各部分（或整个电网）预测不久将来的总体负载。 在此，短期定义为 1 小时到 24 小时范围内的时间范围。 在某些情况下，范围也可能长达 48 小时。 因此，STLF 在电网的运行用例中很常见。 下面是 STLF 定向的用例的一些例子：

* 供需均衡
* 电力交易支持
* 造市（规定电价）
* 电网运行优化
* [需求响应](https://en.wikipedia.org/wiki/Demand_response)
* 高峰需求预测
* 需求面管理
* 负载均衡和预防过载
* 长期负载预测
* 故障和异常检测
* 高峰限电/调节 

STLF 模型大多根据最近（昨天或上周）的用电量数据，以预测温度作为重要的预测因子。 现在，获取将来一小时甚至 24 小时的准确温度预测并不困难。 这些模型较不易受到季节性模式或长期用电量趋势所影响。

SLTF 解决方案也可能引起大量的预测调用（服务请求），因为每小时就要调用一次，在某些情况下甚至更频繁。 机房中每个变电站或变压器往往是独立模型，因此预测请求量甚至更高。

#### <a name="long-term-load-forecasting"></a>长期负载预测
长期负载预测 (LTLF) 的目标是预测时间范围从 1 周到多个月的电力需求（在某些情况下可能是许多年）。 此时间范围最适用于规划和投资用例。

在长期情况下，需要有涵盖多年（至少 3 年）的高质量数据。 这些模型通常从历史数据中提取季节性模式，并使用外部预测因子，例如天气和气候模式。

必须澄清，预测时间越长，预测越不准确。 因此，除了实际预测，还必须生成一些置信区间，以便规划过程中考虑到可能的变数。

由于 LTLF 的用电量方案大多用于规划，预测量必然很低（相比于 STLF）。 我们通常看到这些预测嵌入到可视化工具中，例如 Excel 或 PowerBI，并由用户手动调用。

### <a name="short-term-vs-long-term-prediction"></a>短期与长期预测
下表比较 STLF 和 LTLF 的最重要属性：

| 属性 | 短期负载预测 | 长期负载预测 |
| --- | --- | --- |
| 预测时间范围 |从 1 小时到 48 小时 |从 1 个月到 6 个月以上 |
| 数据粒度 |小时 |小时或日 |
| 典型用例 |<ul><li>供需均衡</li><li>高峰时段预测</li><li>需求响应</li></ul> |<ul><li>长期规划</li><li>电网资产规划</li><li>资源规划</li></ul> |
| 典型预测因子 |<ul><li>日或周</li><li>当天时段</li><li>每小时温度</li></ul> |<ul><li>年度月份</li><li>月份日期</li><li>长期温度和气候</li></ul> |
| 历史数据范围 |二到三年的数据 |五到十年的数据 |
| 典型准确度 |5% 或更低的 MAPE* |25% 或更低的 MAPE* |
| 预测频率 |每小时或每 24 小时生成一次 |每月、每季或每年生成一次 |

\*[MAPE](https://en.wikipedia.org/wiki/Mean_absolute_percentage_error) - 平均百分比误差

从此表格可以看出，区别短期和长期预测方案相当重要，因为这些参数代表不同的业务需求，可能有不同的部署和用电模式。

### <a name="example-use-case-1-esmart-systems--overload-optimization"></a>示例用例 1：eSmart Systems – 过载优化
[智能电网](https://en.wikipedia.org/wiki/Smart_grid)是一个重要角色是随着不断变化的用电模式，而动态和持续地优化并调整。 用电量可能受到短期变化所影响，主要是温度变动所造成（*例如*，空调或暖气的用电增加）。 同时，用电量也受到长期趋势所影响。 其中包括季节效应、法定节假日、长期用电量增长，甚至经济因素，例如消费指数、石油价格和 GDP。

在本用例中，[eSmart](https://www.esmartsystems.com/) 想要部署基于云的解决方案，预测电网的任何给定变电站发生过载情况的倾向。 具体而言，eSmart 希望找到下一个小时可能过载的变电站，以便立即采取措施来避免或解决这种情况。

为了准确快速预测，必须实现三个预测模型：

* 可预测每个变电站将来几周或几个月用电量的长期模型
* 可预测给定变电站在下一个小时发生过载情况的短期模型
* 在多个方案上提供将来温度预测的温度模型

长期模型的目标是依下一周或下个月的过载倾向将变电站排名（根据其电力输送能力）。 这样可创建一份变电站初步名单，作为短期预测的输入。 由于温度是长期模型的重要预测因子，需要不断生成多重方案的温度预测，并输入到长期模型中。 然后调用短期预测，以预测下一个小时可能过载的变电站。

每个变电站个别地部署短期和长期模型。 因此，生产这些模型需要大量的协调流程。 为了在短期内获得更高的预测精确度，有更细微的模型专用于一天的每个小时。 所有这些模型每个小时都执行，并在几分钟内执行完毕，以便有充裕的时间来响应，并根据需要采取预防措施。 这组模型定期以最新数据重新训练，随时保持在最新状态。

[此处](https://customers.microsoft.com/Pages/CustomerStory.aspx?recid=18945)提供了本用例的详细信息。

#### <a name="use-case-qualification-criteria--prerequisites"></a>用例检定准则 – 先决条件
Cortana Intelligence 的真正威力在于有强大的能力部署及调整以机器学习为中心的解决方案。 目的是支持数以千计同时运行的预测。 它可以自动缩放，符合不断变化的用电模式。 因此，解决方案的重点是精确度和计算性能。 例如，公共事业公司的兴趣是为下一个小时及一天中每个小时生成准确的能源需求预测。 相反地，我们较没兴趣回答为何预测这种需求的问题（这是由模型本身来处理）。

因此，必须了解，并非所有用例和业务问题都能使用机器学习来有效解决。

只要符合以下条件，Cortana Intelligence 和机器学习可以很有效地解决特定的业务问题：

* 眼前的业务问题在本质上有**预测性**。 例如，一家公共事业公司想要预测给定变电站下一个小时内的电源负载，这就是预测用例。 另一方面，分析和排名历史需求的驱动因素在本质上是**描述性的**，因此较不适用。
* 获得预测后，即可采取明确的**操作途径**。 例如，预测变电站下一个小时过载可以触发积极的移动，降低该变电站的相关负载，因而避免可能发生的过载。
* 本用例代表一个**典型的问题**，只要解决它，就能轻松解决其他类似的用例。
* 客户可以设置**量化和质化目标**，演示成功的解决方案实现。 例如，必要的准确度阈值（*例如*，最高容许 5% 的错误），或在预测变电站过载时，准确度（真肯定率）和回溯（真肯定的程度）应超过指定的阈值，都是能源需求预测的良好量化目标。 这些目标应该派生自客户的业务目标。
* 对于公司的业务工作流，有一个明确的**集成方案**。 例如，变电站负载预测可以集成到电网控制中心，以利于进行过载预防活动。
* 客户已准备使用**质量足够的数据**来支持用例（详情请参阅本演练手册的下部分**数据质量**）。
* 客户接受以云为中心的数据架构或**基于云的机器学习**，包括 Azure ML 和其他 Cortana Intelligence Suite 组件。
* 客户愿意创建**端到端数据流**，以便持续将数据传入云中，同时愿意**实施**解决方案。
* 客户已准备**提供专用资源**来主动参与初始试验实现过程，以便在成功完成时，可将解决方案的知识和所有权转移给客户。
* 客户资源应该是**熟练的数据专业人员**，最好是数据科研人员。

根据上述准则检定用例，可大幅提高用例的成功率，为实现将来的用例打下良好基础。

### <a name="cloud-based-solutions"></a>基于云的解决方案
Cortana Intelligence Suite 是云中的集成环境。 在云环境中部署高级的分析解决方案，可为企业带来明显的效益，同时，为仍使用本地 IT 解决方案的公司带来巨大的革新。 在能源行业，明显看出运营逐渐转向云的趋势。 这种趋势与上述**行业趋势**中的智能电网发展同步并进。 由于本演练手册着重于能源领域中基于云的解决方案，因此必须说明部署基于云的解决方案带来的优点和其他注意事项。

基于云的解决方案带来的最大优势可能就是成本。 由于解决方案使用云部署的组件，因此不需要前期成本或相关的 COGS（销货成本）组件成本。 这意味着不需要投资硬件、软件和 IT 维护，因而大幅降低业务风险。

另一个重要优点是基于云的解决方案采用即用即付成本结构。 作为计算或存储用途的基于云的服务器，可以根据需要而部署和缩放。 这代表基于云的解决方案带来的成本效益优势。

最后，不需要投资 IT 维护或将来的基础结构开发，由于基于云的产品中已一应俱全。 就这点而言，Cortana Intelligence Suite 包含最优秀的服务，而其路线图仍在持续拓展。 新特征、组件和功能持续推出和演进。

对于刚开始转换到云的公司，强烈建议实现云迁移路线图，采取渐进方式。 对于能源领域中的公共事业或公司，我们相信本演练手册所介绍的用例，就代表在云中试验预测分析解决方案的绝佳机会。

#### <a name="business-case-justification-considerations"></a>业务用例论证注意事项
在许多情况下，客户可能想要对给定的用例发出一个业务理由，表明基于云的解决方案和机器学习是重要的组件。 不同于本地解决方案，在基于云的解决方案中，前期成本的成分极少，大多数的成本要素都与实际用量有关。 在 Cortana Intelligence Suite 中部署预测能源解决方案时，多个服务可以与单个的一般成本结构集成。 例如，数据库（*例如* SQL Azure）可以用于存储原始数据，并在实际预测时，使用 Azure ML 来托管预测服务。 在此示例中，成本结构可能包括存储和事务组件。

另一方面，应该要正确了解从事能源需求预测（短期或长期）的业务价值。 事实上，必须了解每个预测操作的业务价值。 例如，准确预测接下来 24 小时内的电力负载，可以避免生产过剩或电网过载，还能从每日节省的资金来量化这方面的信息。

需求预测解决方案财务优势的基本计算公式为：![需求预测解决方案财务优势的基本计算公式](media/cortana-analytics-playbook-demand-forecasting-energy/financial-benefit-formula.png)

由于 Cortana Intelligence Suite 提供即用即付价格模式，因此不需要将固定成本项带入此公式中。 每日、每月或每年都可以计算此公式。

[此处](https://azure.microsoft.com/pricing/details/machine-learning/)提供了 Cortana Intelligence Suite 和 Azure ML 的最新定价计划。

### <a name="solution-development-process"></a>解决方法开发过程
能源需求预测解决方案的开发周期通常需要 4 个阶段，在所有阶段中，都采用 Cortana Intelligence Suite 中基于云的技术和服务。

下图对此做了演示：

![智能电网周期](media/cortana-analytics-playbook-demand-forecasting-energy/smart-grid-cycle.png)

以下段落描述了这个 4 步骤过程：

1. **数据收集** – 任何基于高级分析的解决方案都依赖于数据（请参阅**了解数据**）。 具体而言，在提到预测分析和预测时，我们依赖于持续、动态的数据流。 就能源需求预测而言，此数据可能直接来自智能电表，或已在本地数据库中聚合。 我们还依赖于其他外部数据源，例如天气和温度。 必须协调、计划和存储此持续数据流。 [Azure 数据工厂](https://azure.microsoft.com/services/data-factory/) (ADF) 是用于完成此任务的主要工具。
2. **建模** – 为了获得准确又可靠的能源预测，必须开发（训练）并维护一个优秀的模型，使用历史数据并从数据中提取有用且可预测的模式。 随着不断开发出先进的算法，机器学习 (ML) 领域一直在快速发展。 Azure 机器学习工作室提供绝佳的用户体验，有助于在完整的工作流中使用最先进的 ML 算法。 该工作流在直观的流程图中演示，包含准备数据、提取特征、建模和评估模型。 用户可以使用此环境中数以百计的各种不同模型。 此阶段结束时，数据科研人员可获得一个已完整评估且可部署的有效模型。
   
   下图演示了典型的工作流：
   
   ![建模工作流](media/cortana-analytics-playbook-demand-forecasting-energy/modeling-workflow.png)
3. **部署** – 获得任务模型后，下一步就是部署。 在此，模型转换为 Web 服务并公开 RESTful API，供各种用电客户端通过 Internet 同时调用。 Azure ML 提供简单的方法，直接从 Azure 机器学习工作室中单击按钮，就能部署模型。 整个部署过程会自动完成。 此解决方案可以自动调整规模以符合所需的用电量。
4. **用电量** – 在此阶段，我们实际使用预测模型来生成预测。 用电量可由用户应用程序（*例如*仪表板）或直接从操作系统来控管，例如供需均衡系统或电网优化解决方案。 单个模型可以控管多个用例。

## <a name="data-understanding"></a>了解数据
介绍能源需求预测解决方案的业务注意事项之后（请参阅**了解业务**），现在可以开始介绍数据部分。 任何预测分析解决方案都依赖于可靠的数据。 在能源需求预测方面，我们依赖不同粒度的用电量历史数据。 该历史数据就成为原始材料。 经过仔细分析，数据科研人员将找到预测因子（也名为特征），然后输入模型中，最后生成所需的预测。

本部分的余下内容描述各种步骤和注意事项，介绍数据及如何转换为有用的格式。

### <a name="the-model-development-cycle"></a>模型开发周期
需要仔细准备和规划才能生成良好的预测模型。 将建模过程分解成多个步骤，且一次专注于一个步骤，如此即可大幅改善整个过程的结果。

下图演示如何将建模过程分解成多个步骤：

![模型开发周期](media/cortana-analytics-playbook-demand-forecasting-energy/model-development-cycle.png)

从上图可知，周期包含六个步骤：

* 问题表述
* 数据引入和数据探索
* 数据准备和特征设计
* 建模
* 模型评估
* 开发

本部分的余下内容描述各个步骤及每个步骤需要注意的事项。

### <a name="problem-formulation"></a>问题表述
问题表述可视为在实现任何预测分析解决方案之前需要执行的最重要步骤。 在此我们转换业务问题，并将它分解成使用数据和建模技术就可解决的特定要素。 最好将问题表述成一组需要回答的问题。 下面是能源需求预测范围内可能适用的一些问题：

* 单个变电站在下一个小时或次日预期的负载是什么？
* 电网在一天之中何时遇到高峰需求？
* 电网对预期高峰负载的承受力如何？
* 发电厂在一天的每个小时内生产多少电力？

拟定这些问题可让我们专注于获取正确的数据，充分配合眼前的业务问题来实现解决方案。 此外，我们可以再设置一些重要的指标，评估模型的性能。 例如，预测应该有多高的准确度及企业仍可接受多大的错误范围？

### <a name="data-sources"></a>数据源
现代智能电网从电网的各种组件和组件收集数据。 此数据代表电网运行和使用的各个层面。 在能源需求预测的范围内，我们的介绍仅限于可反映实际需求消耗的数据源。 能源消耗量的重要信息源之一是智能电表。 世界各地的公共事业正快速地为消费者部署智能电表。 智能电表记录实际的用电量，并不断地将此数据转发给公共事业公司。 数据是以固计时间间隔收集并返回，范围从每 5 分钟到 1 小时。 更先进的智能电表可远程控制，均衡家庭内的实际用电量。 智能电表数据相当可靠，并且包含时间戳。 因此成为需求预测的重要元素。 电表数据可以电网拓扑内的各个级别聚合（累加）：变压器、变电站、区域，*等等*。然后，我们可以选择聚合级别来构建预测模型。 例如，如果公共事业公司想要预测每一个电网变电站的将来负载，则可以针对每个变电站来聚合所有电表的数据，作为预测模型的输入。 我们将智能电表称为内部数据源。

可靠的能源需求预测也依赖其他外部数据源。 影响用电量的一个重要因素是天气，更准确地说是温度。 历史数据显示室外温度和用电量之间有很大的关系。 在酷暑季节，消费者会使用空调，而冬季则会打开暖气系统。 因此，关键在于电网地点要有可靠的历史温度源。 此外，我们还依赖准确预测的温度作为用电量的预测因子。

其他外部数据源也有助于创建能源需求预测模型。 其中可能包括长期气候变化、经济指标（*例如* GDP）等。 本文不介绍其他这些数据源。

### <a name="data-structure"></a>数据结构
确定所需的数据源之后，需要确保已收集的原始数据包含正确的数据特征。 要创建可靠的需求预测模型，需要确保收集的数据包含有助于预测将来需求的数据元素。 下面是关于原始数据的数据结构（架构）的一些基本要求。

原始数据由行和列构成。 每个测量值以单个行表示。 每个行包含多个列（也称为特征或字段）。

1. **时间戳** – 时间戳字段代表记录测量值时的实际时间。 它应该符合其中一种常见的日期/时间格式。 应该同时包含日期和时间部分。 在大多数情况下，除非达到“秒”的粒度级，否则不需要记录时间。 必须指定记录数据的时区。
2. **电表 ID** - 此字段指定电表或测量设备。 它是一个分类变量，可以是数字和字符的组合。
3. **用电量值** – 这是在给定日期/时间的实际用电量。 用电量可以通过 kWh（千瓦时）或任何其他首选单位来测量。 请务必注意，在所有数据测量中，测量单位必须保持一致。 在某些情况下，可能分成 3 个电源相位来供电。 在此情况下，需要收集所有独立的供电相位。
4. **温度** – 通常从独立的源收集温度。 但是，它应该与用电量数据兼容。 应该包含如上所述的时间戳，以便与实际用电量数据保持同步。 温度值可以指定为摄氏或华氏度，但在所有测量中应保持一致。
5. **位置** – 位置字段通常与收集温度数据的位置关联。 可以用邮政编码或经纬度格式表示。

下表显示了正确用电量和温度数据格式的示例：

| **日期** | **时间** | **电表 ID** | **相位 1** | **相位 2** | **相位 3** |
| --- | --- | --- | --- | --- | --- |
| 7/1/2015 |10:00:00 |ABC1234 |7.0 |2.1 |5.3 |
| 7/1/2015 |10:00:01 |ABC1234 |7.1 |2.2 |4.3 |
| 7/1/2015 |10:00:02 |ABC1234 |6.0 |2.1 |4.0 |

| **日期** | **时间** | **位置** | **温度** |
| --- | --- | --- | --- |
| 7/1/2015 |10:00:00 |11242 |24.4 |
| 7/1/2015 |10:00:01 |11242 |24.4 |
| 7/1/2015 |10:00:02 |11242 |24.5 |

从上面可以看出，本示例包括与 3 电源相位关联的 3 个不同用电量值。 另外，请注意日期和时间字段分隔，但也可以结合成单个列。 在此方案中，位置列以 5 位数邮政编码格式表示，温度以摄氏度格式表示。

### <a name="data-format"></a>数据格式
Cortana Intelligence Suite 支持最常见的数据格式，例如 CSV、TSV、JSON，*等等*。在项目的整个生命周期，数据格式必须保持一致。

### <a name="data-ingestion"></a>数据提取
由于能源需求预测是持续且经常性的，因此必须确保有一个稳定可靠的数据引入过程不断地传送原始数据。 引入过程必须保证预测过程在需要时一定可以获取原始数据。 这意味着数据引入频率应该高于预测频率。

例如：如果需求预测解决方案在每天上午 8:00 生成新的预测，则需要确保在此之前已完全引入过去 24 小时内已收集的所有数据，甚至包括过去一小时的数据。

为实现此目的，Cortana Intelligence Suite 提供各种方法来支持可靠的数据引入过程。 本文档的**部署**部分将做进一步的介绍。

### <a name="data-quality"></a>数据质量
为了运行可靠且正确的需求预测，所需的原始数据源必须符合一些基本的数据质量准则。 尽管高级统计方法可以用于弥补一些可能的数据质量问题，但在提取新的数据时，我们仍然需要确保跨越某些基本的数据质量门坎。 下面是关于原始数据质量的一些注意事项：

* **缺失值** – 指未收集到特定测量值的情况。 在此，基本请求是在任何指定的期间，缺失值比率都不应该超过 10%。 如果缺失单个值，应该以预先定义的值（例如：'9999'）表示，而不是可能为有效测量值的 '0'。
* **测量准确度** – 应该正确记录用电量或温度的实际值。 不准确的测量会产生不准确的预测。 一般而言，相对于真实值，测量误差应该低于 1%。
* **测量时间** – 相对于实际测量的真正时间，收集数据的实际时间戳不能偏离超过 10 秒。
* **同步** – 使用多个数据源时（*例如*，用电量和温度），必须确保它们之间没有时间同步问题。 这意味着从任何两个独立的数据源收集的时间戳之间，时差不应超过 10 秒以上。
* **延迟** - 如前面**数据引入**中所述，我们依赖于可靠的数据流和引入过程。 为了做好控制，必须控制数据延迟。 这指定为从进行实际测量的时间，到已加载到 Cortana Intelligence Suite 存储且可供使用的时间，两者之间的时差。 对于短期负载预测，总延迟时间不应该超过 30 分钟。 对于长期负载预测，总延迟时间不应该超过 1 天。

### <a name="data-preparation-and-feature-engineering"></a>数据准备和特征设计
引入原始数据（请参阅**数据引入**）并安全存储后，就可以开始处理。 简单地说，数据准备阶段是获取原始数据并转换（变换、重塑）成适用于建模阶段的格式。 其中包括简单的操作，例如直接使用原始数据列及其实际测量值、标准化值，还有更复杂的操作，例如[时间延隔](https://en.wikipedia.org/wiki/Lag_operator)等。 新建的数据列称为数据特征，生成这些特征的过程称为特征设计。 此过程结束时，会获得一组从原始数据派生的、可用于建模的新数据集。 此外，数据准备阶段还必须处理并补偿缺失值（请参阅**数据质量**）。 在某些情况下，还需要将数据规范化，确保所有值以相同的标度表示。

本部分列出能源需求预测模型包含的一些常见数据特征。

**时间驱动的特征：** 这些特征派生自日期/时间戳数据。 这些数据在提取后转换为分类别特征，例如：

* 当天时间 – 这是一天中的时段，接受的值从 0 到 23
* 星期 – 这代表星期几，接受的值从 1（星期日）到 7（星期六）
* 月份日期 – 这代表实际的日期，接受的值从 1 到 31
* 年度月份 – 这代表月份，接受的值从 1（一月）到 12（十二月）
* 周末 – 这是二进制值特征，接受的值为 0（工作日）或 1（周末）
* 节假日 – 这是二进制值特征，接受的值为 0（平日）或 1（假日）
* 傅立叶项 – 傅立叶项是派生自时间戳的权重，用于捕获数据中的季节性（周期）。 由于数据中可能有多个季节，因此可能需要多个傅立叶项。 例如，需求值可能有每年、每周和每日季节/周期，因此需要 3 个傅立叶项。

**独立测量特征：** 独立特征包括我们想要在模型中作为预测因子的所有数据元素。 在此我们排除需要预测的依赖特征。

* 延隔特征 – 这些是实际需求的时间偏移值。 例如，相对于当前时间戳，延隔 1 的特征保留前一个小时的需求值（假设是每小时数据）。 同样，可以添加延隔 2、延隔 3，*等等*。实际使用的延隔时间组合在建模阶段经由评估模型结果确定。
* 长期趋势 – 此特征代表年份之间需求的线性增长。

**依赖特征：** 依赖特征是模型要预测的数据列。 使用[监督式机器学习](https://en.wikipedia.org/wiki/Supervised_learning)时，需先使用依赖特征（也称为标签）来训练模型。 这样可让模型从依赖特征关联的数据中学习模式。 在能源需求预测中，通常需要预测实际需求，因此将它用作依赖特征。

**处理缺失值：** 在数据准备阶段，需要确定最佳策略来处理缺失值。 我们主要使用不同的统计[数据插补法](https://en.wikipedia.org/wiki/Imputation_\(statistics\))实现此目的。 以能源需求预测而言，通常从以前可用的数据点使用移动平均来推算缺失值。

**数据规范化：** 数据规范化是另一种转换，用于将所有数值数据（例如需求预测）变成类似的标度。 这通常有助于改善模型的精准度。 在做法上，我们通常根据数据范围来分割实际值。
这会将原始值按比例缩小到较小范围，通常介于 -1 和 1 之间。

## <a name="modeling"></a>建模
建模阶段将数据转换为模型。 此过程的核心是高级的算法，负责扫描历史数据（训练数据）、提取模式及创建模型。 稍后，该模型可用于预测未用于创建模型的新数据。

获得可靠的任务模型后，可以用它来评比在结构上包含所需特征 (X) 的新数据。 评分过程使用持续性模型（来自训练阶段的对象），预测由 Ŷ 表示的目标变量。

### <a name="demand-forecasting-modeling-techniques"></a>需求预测建模技巧
在需求预测方面，可使用按时间排序的历史数据。 我们通常将包含时间维度的数据称为[时序](https://en.wikipedia.org/wiki/Time_series)。 时序建模的目的是查找时间相关的趋势、季节性、自动相关（经过一段时间的相互关联），并将这些要素编成模型。

在最近几年，已开发出高级算法来配合时间序列预测，并改善预测准确度。 在此我们将简要介绍其中的一部分技巧。

> [!NOTE]
> 本部分并非机器学习和预测的概述，只是简单探讨需求预测常用的建模技巧。 有关时序预测的详细信息和教材，强烈建议阅读在线丛书 [Forecasting: principles and practice](https://www.otexts.org/book/fpp)（预测：原理和实践）。
> 
> 

#### <a name="ma-moving-averagehttpswwwotextsorgfpp62"></a>[**MA（移动平均）**](https://www.otexts.org/fpp/6/2)
移动平均是时序预测的第一代分析技巧之一，目前仍很常用。 它也是更高级预测技巧的基础。 使用移动平均时，可将 K 个最近数据点算出平均值，预测下一个数据点，其中 K 表示移动平均的顺序。

移动平均技巧具有将预测平滑化的效果，因此可能无法处理数据中的急剧波动。

#### <a name="ets-exponential-smoothinghttpswwwotextsorgfpp75"></a>[**ETS（指数平滑）**](https://www.otexts.org/fpp/7/5)
指数平滑 (ETS) 由一系列方法组成，使用最近数据点的加权平均来预测下一个数据点。 其思路是将较高权重分配给较新的值，而对于较旧的测量值，逐渐降低此权重。 此方法系列包括许多不同的方法，其中一些方法可处理数据中的季节性，例如 [Holt-Winters 季节性方法](https://www.otexts.org/fpp/7/5)。

还有一些方法也会考虑数据的季节性。

#### <a name="arima-auto-regression-integrated-moving-averagehttpswwwotextsorgfpp8"></a>[**ARIMA（自动回归集成移动平均）**](https://www.otexts.org/fpp/8)
自动回归集成移动平均 (ARIMA) 是常用于时序预测的另一种方法系列。 实际上是结合自动回归方法与移动平均。 自动回归方法使用回归模型时获取以前的时序值来计算下一个日期点。 ARIMA 方法也利用差异性方法，包括计算数据点之间的差异，以及使用它们而不是原始的测量值。 最后，ARIMA 也使用上面所述的移动平均技巧。 以各种方式将所有这些方法组合起来，就构成 ARIMA 方法系列。

ETS 和 ARIMA 现在广泛用于能源需求预测和其他许多的预测问题。 在许多情况下，这些结合起来可提供非常准确的结果。

**普通多元回归**回归模型可能是机器学习和统计学领域中最重要的建模方法。 在时序方面，我们使用回归来预测未来值（*例如*，需求）。 在回归中，我们获取预测值的线性组合，并在训练过程中学习这些预测值的权重（也称系数）。 目标是生成回归线来预测预测值。 当目标变量为数值时，就适合使用回归法，因此也适用于时序预测。 有各种不同的回归法，包括非常简单的回归模型，例如[线性回归](https://en.wikipedia.org/wiki/Linear_regression)，还有更高级的回归法，例如决策树、[随机林](https://en.wikipedia.org/wiki/Random_forest)、[神经网络](https://en.wikipedia.org/wiki/Artificial_neural_network)和提升决策树。

将能源需求预测当作回归问题来构造，让我们在选择数据特征时很有弹性，这些特征可能结合自实际的需求时序数据和外部因素（例如温度）。 本演练手册的“特征设计”（请参阅**数据准备和特征设计**）部分中介绍了所选特征的详细信息。

根据我们在实施和部署能源需求预测试验的经验，发现 Azure ML 中可用的高级回归模型可以产生最佳结果，因此利用了该模型。

## <a name="model-evaluation"></a>模型评估
模型评估在**模型开发周期**中扮演重要的角色。 在此步骤中，我们以现实生活中的数据来探讨验证模型及其表现。 在建模步骤期间，使用一部分可用的数据来训练模型。 在评估阶段，使用剩余的数据来测试模型。 实际上，这意味着在模型中输入的新数据已重新编排，且包含与训练数据集相同的特征。 但是，在验证过程中，使用模型来预测目标变量，而不是提供可用的目标变量。 我们通常将此过程称为模型评分。 然后，使用真实目标值，并与预测值做比较。 在此，目标是测量并最小化预测误差，也就是预测值与真实值之间的差异。 量化误差测量值是关键，由于我们想要微调模型，验证是否确实减少了误差。 微调模型可以通过修改控制学习过程的模型参数，也可以通过添加或删除数据特征（称为[参数扫掠](https://channel9.msdn.com/Blogs/Azure/Data-Science-Series-Building-an-Optimal-Model-With-Parameter-Sweep)）来实现。 实际上，这意味着我们可能需要在特征设计、建模和模型评估阶段之间反复许多次，直到能够将错误减少到所需的程度为止。

必须强调，预测误差永远不会是零，因为从来没有任何模型能够完美预测所有结果。 但是，企业仍可接受一定程度的误差。 在验证过程中，需要确保模型预测误差等于或高于企业容许度。 因此，在**问题表述**阶段周期的开头，就必须规定误差容许度。

### <a name="typical-evaluation-techniques"></a>典型评估方法
有多种方法可以测量和量化预测误差。 本部分侧重于介绍有关时序的预测技巧，尤其是能源需求预测。

#### <a name="mapehttpsenwikipediaorgwikimeanabsolutepercentageerror"></a>[**MAPE**](https://en.wikipedia.org/wiki/Mean_absolute_percentage_error)
MAPE (Mean Absolute Percentage Error) 是“平均绝对百分比误差”的缩写。 使用 MAPE 来计算每一个预测点和该点的实际值之间的差异。 然后，计算差异相对于实际值的比例，量化每个点的误差。 在最后一个步骤，求这些值的平均。 MAPE 使用的数学公式如下：

![MAPE 公式](media/cortana-analytics-playbook-demand-forecasting-energy/mape-formula.png)
*其中 A<sub>t</sub> 是实际值，F<sub>t</sub> 是预测值，n 是预测时间范围。*

## <a name="deployment"></a>部署
完成建模阶段后，即已验证模型性能，接下来可以开始进入部署阶段。 在本文的语境中，部署是指客户利用模型大规模执行实际预测。 部署的概念是 Azure ML 中的关键，因为我们的主要目的是不断调用预测，而不是只从数据找到领悟而已。 在部署阶段，模型开始被大规模利用。

在能源需求预测方面，我们的目标是调用连续和定期的预测，同时确保模型可获取最新的数据，并将预测的数据返回给使用方客户端。

### <a name="web-services-deployment"></a>Web 服务部署
在 Azure ML 中，主要的可部署构建块是 Web 服务。 这是在云中使用预测模型的最有效方式。 Web 服务封装模型，并以 [RESTful](https://www.restapitutorial.com/) API（应用程序编程接口）来包装它。 API 可用作任何客户端代码的一部分，如下图所示。

![Web 服务部署和使用](media/cortana-analytics-playbook-demand-forecasting-energy/web-service-deployment-and-consumption.png)

由此可知，Web 服务部署在 Cortana Intelligence Suite 云中，并通过其公开的 REST API 终结点来调用。 位于不同域中的各种不同的客户端可以通过 Web API 服务来同时调用服务。 Web 服务也可以扩展，以便支持数千个并发调用。

### <a name="a-typical-solution-architecture"></a>典型的解决方案体系结构
在部署能源需求预测解决方案时，我们的兴趣是部署端到端解决方案，超越预测 Web 服务，并加速整个数据流。 调用新预测时，必须确保可向模型馈送最新的数据特征。 这意味着，需要不断地引入、处理和转换新收集的原始数据，成为赖以创建模型的必要特征。 同时，还要将预测的数据提供给最终使用方客户端使用。 下图演示了一个示例数据流周期（或数据管道）：

![能源需求预测的端到端数据流](media/cortana-analytics-playbook-demand-forecasting-energy/energy-demand-forecase-end-data-flow.png)

下面是能源需求预测周期的步骤：

1. 数百万个已部署的数据仪表不断地实时生成用电量数据。
2. 此数据收集后上传到云存储库（例如 Azure Blob）。
3. 在处理之前，原始数据先聚合到企业定义的变电站或区域级别。
4. 然后进行特征处理（请参阅**数据准备和特征处理**），生成模型训练和评分所需的数据 – 特征集数据存储在数据库（*例如* SQL Azure）中。
5. 调用重新训练服务来重新训练预测模型 – 更新后的模型持续保存，可供评分 Web 服务使用。
6. 根据符合所需预测频率的计划来调用评分 Web 服务。
7. 预测的数据存储在最终使用方客户端可访问的数据库中。
8. 使用方客户端检索预测值，将它应用到电网，并根据所需用例使用它。

请务必注意，这整个周期完全自动化，并按计划运行。 可使用 [Azure 数据工厂](https://azure.microsoft.com/services/data-factory/)等工具来全面协调此数据周期。

### <a name="end-to-end-deployment-architecture"></a>端到端部署体系结构
若要在 Cortana Intelligence 中实际部署能源需求预测解决方案，必须确保正确建立并配置所需的组件。

下图演示了可实现并协调上述数据流周期的、基于 Cortana Intelligence 的典型体系结构：

![端到端部署体系结构](media/cortana-analytics-playbook-demand-forecasting-energy/architecture.png)

有关每个组件和整个体系结构的详细信息，请参阅“Energy Solution Template”（能源解决方案模板）。

